<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Day One Juz Tracker</title>
    <style>
        /* Reset dan Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', sans-serif;
            background: linear-gradient(135deg, #FFEEA9 0%, #FFBF78 25%, #FF7D29 75%, #7B4019 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .main-title {
            font-size: clamp(1.5rem, 5vw, 3rem);
            font-weight: 800;
            background: linear-gradient(135deg, #7B4019, #FF7D29, #FFBF78);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            line-height: 1.2;
        }

        .subtitle {
            color: #666;
            font-size: clamp(0.9rem, 3vw, 1.1rem);
        }

        /* Navigation Tabs */
        .nav-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .nav-tabs {
            background: rgba(255, 255, 255, 0.9);
            padding: 6px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 3px;
            width: 100%;
            max-width: 400px;
        }

        .nav-tab {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: #666;
            flex: 1;
            text-align: center;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #FF7D29, #FFBF78);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 125, 41, 0.4);
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            color: #FF7D29;
            background: rgba(255, 125, 41, 0.1);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Firebase Status */
        .firebase-status {
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            background: linear-gradient(135deg, #F59E0B, #FBBF24);
            color: white;
            font-size: clamp(0.8rem, 2.5vw, 0.95rem);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            padding: 20px;
            border-radius: 15px;
            background: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 125, 41, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #FFF7ED, #FFEDD5);
            border-color: #FDBA74;
        }

        .stat-card.amber {
            background: linear-gradient(135deg, #FFFBEB, #FEF3C7);
            border-color: #FDE68A;
        }

        .stat-card.yellow {
            background: linear-gradient(135deg, #FEFCE8, #FEF9C3);
            border-color: #FEF08A;
        }

        .stat-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stat-icon {
            color: #FF7D29;
            font-size: clamp(20px, 5vw, 24px);
            flex-shrink: 0;
        }

        .stat-text {
            color: #7B4019;
            font-weight: 600;
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            line-height: 1.3;
        }

        /* Daily Info */
        .daily-info {
            margin-bottom: 25px;
        }

        .info-card {
            background: linear-gradient(135deg, #EBF8FF, #DBEAFE);
            border: 1px solid #93C5FD;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.1);
        }

        .info-card h4 {
            color: #1E40AF;
            font-weight: 700;
            font-size: clamp(0.95rem, 2.5vw, 1.1rem);
            margin-bottom: 8px;
        }

        .info-card p {
            color: #1E3A8A;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            margin: 4px 0;
            font-weight: 500;
            line-height: 1.4;
        }

        /* Participants Grid - Enhanced for Mobile */
        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .participant-card {
            padding: 16px;
            border-radius: 12px;
            border: 2px solid #E5E7EB;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .participant-card:hover {
            border-color: #FF7D29;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 125, 41, 0.2);
        }

        .participant-card:active {
            transform: translateY(0);
        }

        .participant-card.completed {
            background: linear-gradient(135deg, #ECFDF5, #D1FAE5);
            border-color: #34D399;
        }

        .participant-content {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .participant-info {
            flex: 1;
            min-width: 0; /* For text truncation */
        }

        .participant-info h3 {
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 6px;
            font-size: clamp(0.95rem, 2.5vw, 1.1rem);
        }

        .participant-info p {
            color: #6B7280;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            margin-bottom: 3px;
        }

        .participant-info small {
            font-weight: 600;
            font-size: clamp(0.75rem, 2vw, 0.85rem);
        }

        .juz-info {
            background: #F8F9FA;
            padding: 8px;
            border-radius: 6px;
            margin: 6px 0;
        }

        .juz-info p {
            font-size: clamp(0.75rem, 2vw, 0.85rem);
            color: #374151;
            font-weight: 500;
            margin-bottom: 3px;
        }

        .juz-info .description {
            font-size: clamp(0.7rem, 1.8vw, 0.8rem);
            color: #6B7280;
            font-style: italic;
            line-height: 1.3;
        }

        .participant-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .icon {
            transition: all 0.3s ease;
            font-size: clamp(20px, 4vw, 28px);
        }

        .icon-completed {
            color: #10B981;
        }

        .icon-pending {
            color: #D1D5DB;
        }

        /* Monthly Tab */
        .month-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .month-selector label {
            color: #374151;
            font-weight: 600;
            font-size: clamp(0.95rem, 2.5vw, 1.1rem);
        }

        .month-selector select {
            padding: 10px 14px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            background: white;
            color: #374151;
            font-weight: 500;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 160px;
            flex: 1;
            max-width: 300px;
        }

        .month-selector select:focus {
            outline: none;
            border-color: #FF7D29;
            box-shadow: 0 0 0 3px rgba(255, 125, 41, 0.1);
        }

        /* Monthly Stats */
        .monthly-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .monthly-stat-card {
            padding: 25px;
            border-radius: 15px;
            background: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 125, 41, 0.1);
            transition: all 0.3s ease;
        }

        .monthly-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }

        .monthly-stat-card.orange {
            background: linear-gradient(135deg, #FFF7ED, #FFEDD5);
        }

        .monthly-stat-card.amber {
            background: linear-gradient(135deg, #FFFBEB, #FEF3C7);
        }

        .monthly-stat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .monthly-stat-header h3 {
            color: #7B4019;
            font-weight: 700;
            font-size: clamp(1rem, 2.5vw, 1.2rem);
        }

        .monthly-stat-value {
            font-size: clamp(1.8rem, 5vw, 2.5rem);
            font-weight: 800;
            color: #FF7D29;
        }

        /* Progress Section */
        .progress-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 125, 41, 0.1);
        }

        .progress-section h3 {
            color: #1F2937;
            font-weight: 700;
            font-size: clamp(1.1rem, 3vw, 1.3rem);
            margin-bottom: 20px;
        }

        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .progress-item {
            padding: 16px;
            background: #F9FAFB;
            border-radius: 12px;
            border: 1px solid #E5E7EB;
            transition: all 0.3s ease;
        }

        .progress-item:hover {
            background: #F3F4F6;
            border-color: #D1D5DB;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-name {
            font-weight: 600;
            color: #374151;
            font-size: clamp(0.85rem, 2vw, 0.95rem);
        }

        .progress-count {
            color: #6B7280;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #E5E7EB;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF7D29, #FFBF78);
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        .progress-percentage {
            color: #6B7280;
            font-size: clamp(0.75rem, 1.8vw, 0.8rem);
            text-align: right;
        }

        /* Timezone Display */
        .timezone-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #93C5FD;
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 15px;
            font-size: clamp(0.75rem, 2vw, 0.85rem);
            color: #1E40AF;
            text-align: center;
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .app-container {
                padding: 15px;
                border-radius: 15px;
            }
            
            .nav-tabs {
                padding: 4px;
                gap: 2px;
            }
            
            .nav-tab {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .participants-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .participant-card {
                padding: 14px;
            }
            
            .participant-content {
                gap: 10px;
            }
            
            .participant-actions {
                gap: 4px;
            }
            
            .monthly-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .monthly-stat-card {
                padding: 20px;
            }
            
            .progress-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .month-selector {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .month-selector select {
                width: 100%;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .app-container {
                padding: 12px;
            }
            
            .stat-card {
                padding: 16px;
            }
            
            .participant-card {
                padding: 12px;
            }
            
            .info-card {
                padding: 12px;
            }
            
            .monthly-stat-card {
                padding: 16px;
            }
            
            .progress-section {
                padding: 16px;
            }
            
            .progress-item {
                padding: 12px;
            }
        }

        /* Icons */
        .icon {
            display: inline-block;
        }

        /* Utility classes */
        .text-center { text-align: center; }
        .mb-sm { margin-bottom: 8px; }
        .mb-md { margin-bottom: 16px; }
        .mb-lg { margin-bottom: 24px; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1 class="main-title">One Day One Juz Ibnu Katsir</h1>
            <p class="subtitle">Memantau progress membaca Al-Qur'an bersama</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('daily')">Harian</button>
                <button class="nav-tab" onclick="switchTab('monthly')">Rekap Bulanan</button>
            </div>
        </div>

        <!-- Daily Tab -->
        <div id="daily-tab" class="tab-content active">
            <!-- Timezone Info -->
            <div class="timezone-info" id="timezone-info">
                <span id="timezone-text">🕐 Waktu: Loading... (WIB)</span>
            </div>

            <!-- Firebase Status -->
            <div class="firebase-status" id="firebase-status">
                <span id="firebase-status-text">Status: 🟡 Checking Firebase...</span>
                <div id="firebase-actions" style="margin-top: 10px; display: none;">
                    <button onclick="testFirebaseConnection()" style="
                        background: rgba(255,255,255,0.2);
                        color: white;
                        border: none;
                        padding: 5px 10px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 0.8rem;
                    ">🔄 Test Connection</button>
                </div>
            </div>

            <!-- Header Stats -->
            <div class="stats-grid">
                <div class="stat-card orange">
                    <div class="stat-content">
                        <span class="stat-icon">📅</span>
                        <span class="stat-text" id="current-date">Loading...</span>
                    </div>
                </div>
                
                <div class="stat-card amber">
                    <div class="stat-content">
                        <span class="stat-icon">👥</span>
                        <span class="stat-text"><span id="completed-today">0</span>/30 Selesai Hari Ini</span>
                    </div>
                </div>
                
                <div class="stat-card yellow">
                    <div class="stat-content">
                        <span class="stat-icon">🏆</span>
                        <span class="stat-text" id="khatam-status">30 Lagi untuk Khatam</span>
                    </div>
                </div>
            </div>

            <!-- Daily Info -->
            <div class="daily-info">
                <div class="info-card">
                    <h4>Ya Allah, turunkan rahmat kepada kami dengan wasilah bacaan Al-Quran</h4>
                    <p>Jadikan kami lebih mencintai untuk berinteraksi dengan Al Qur'an daripada berbuat sia-sia</p>
                    <p>Anugerahkan kami pemahaman Al Qur'an dan pengamalannya</p>
                    <p>Perkenankan Al-Qur'an memberi syafaat untuk kami</p>
                </div>
            </div>

            <!-- Participants Grid -->
            <div class="participants-grid" id="participants-grid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Monthly Tab -->
        <div id="monthly-tab" class="tab-content">
            <!-- Month Selector -->
            <div class="month-selector">
                <label>Pilih Bulan:</label>
                <select id="month-selector" onchange="updateMonthlyView()">
                    <!-- Will be populated by JavaScript -->
                </select>
            </div>

            <!-- Monthly Stats -->
            <div class="monthly-stats">
                <div class="monthly-stat-card orange">
                    <div class="monthly-stat-header">
                        <span class="stat-icon">🏆</span>
                        <h3>Khatam Bulan Ini</h3>
                    </div>
                    <div class="monthly-stat-value" id="monthly-khatam">0x</div>
                </div>
                
                <div class="monthly-stat-card amber">
                    <div class="monthly-stat-header">
                        <span class="stat-icon">📊</span>
                        <h3>Total Partisipasi</h3>
                    </div>
                    <div class="monthly-stat-value" id="monthly-participation">0</div>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section">
                <h3>Progress Peserta</h3>
                <div class="progress-grid" id="progress-grid">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, collection, getDocs, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Make Firebase functions available globally
        window.firebaseModules = {
            initializeApp,
            getFirestore,
            doc,
            setDoc,
            collection,
            getDocs,
            onSnapshot,
            query,
            orderBy
        };
        
        // Initialize the app after Firebase modules are loaded
        window.initAppAfterFirebase();
    </script>

    <script>
        // Application Data - NAMA PESERTA YANG SUDAH DIPERBAIKI
        const participantNames = [
            'Syafiq',      // Peserta 1
            'Siti',        // Peserta 2  
            'Muhammad',    // Peserta 3
            'Fatimah',     // Peserta 4
            'Abdul',       // Peserta 5
            'Khadijah',    // Peserta 6
            'Umar',        // Peserta 7
            'Maryam',      // Peserta 8
            'Ali',         // Peserta 9
            'Said',        // Peserta 10
            'Yusuf',       // Peserta 11
            'Zainab',      // Peserta 12
            'Hamza',       // Peserta 13
            'Aminah',      // Peserta 14
            'Khalid',      // Peserta 15
            'Hafsa',       // Peserta 16
            'Bilal',       // Peserta 17
            'Nur',         // Peserta 18
            'Salman',      // Peserta 19
            'Ummu',        // Peserta 20
            'Zaid',        // Peserta 21
            'Asma',        // Peserta 22
            'Talhah',      // Peserta 23
            'Habibah',     // Peserta 24
            'Sadil',       // Peserta 25
            'Saris',       // Peserta 26
            'Abdullah',    // Peserta 27
            'Juwed',       // Peserta 28
            'Anas',        // Peserta 29
            'Umming'       // Peserta 30
        ];

        // Detail Juz dan Ayat - DETAIL BACAAN SETIAP JUZ
        const juzDetails = {
            1: { 
                surah: "Al-Fatihah - Al-Baqarah : 141", 
                pages: "1-21",
                description: "Semoga Allah mudahkan"
            },
            2: { 
                surah: "Al-Baqarah : 142 - 253", 
                pages: "22-41",
                description: "Baca sampai ayat 253 agar tidak memotong tema"
            },
            3: { 
                surah: "Al-Baqarah:254 - Ali Imran:91", 
                pages: "42-61",
                description: "Mulai dari ayat 254"
            },
            4: { 
                surah: "Ali Imran:92 - An-Nisa 4:22", 
                pages: "61-81",
                description: "Baca sampai ayat 22 An Nisa untuk menyesuaikan tema"
            },
            5: { 
                surah: "An-Nisa 23 - 147", 
                pages: "83-102",
                description: "Baca dari ayat 23"
            },
            6: { 
                surah: "An-Nisa:148 - Al-Maidah:81", 
                pages: "102-121",
                description: "Baca sampai ayat 81 untuk menyesuaikan tema"
            },
            7: { 
                surah: "Al-Maidah 5:82 - Al-An'am 6:107", 
                pages: "122-141",
                description: "Mulai dari ayat 82, berhenti di ayat 107 surat Al An'am untuk menyesuaikan tema"
            },
            8: { 
                surah: "Al-An'am:108 - Al-A'raf:84", 
                pages: "141-162",
                description: "Baca dari ayat 108 Al An'am"
            },
            9: { 
                surah: "Al-A'raf:85 - Al-Anfal:40", 
                pages: "161-181",
                description: "Baca dari ayat 85 surat Al A'raf"
            },
            10: { 
                surah: "Al-Anfal:41 - At-Taubah:89", 
                pages: "183-202",
                description: "Cukup baca sampai At Taubah:89 untuk menyesuaikan tema"
            },
            11: { 
                surah: "At-Taubah:90 - akhir surat Yunus", 
                pages: "201-221",
                description: "Mulai dari ayat 90 surat At Taubah"
            },
            12: { 
                surah: "Awal surat Hud - Yusuf:57", 
                pages: "221-242",
                description: "Tambah baca sampai ayat 57 surat Yusuf untuk menyeseuaikan tema"
            },
            13: { 
                surah: "Yusuf:58 - akhir surat Ibrahim", 
                pages: "242-261",
                description: "Baca dari ayat 58 surat Yusuf"
            },
            14: { 
                surah: "Al-Hijr & An-Nahl", 
                pages: "262-281",
                description: ""
            },
            15: { 
                surah: "Al-Isra - Al-Kahf:82", 
                pages: "282-302",
                description: "Tambah baca sampai ayat 82, syukur-syukur sampai akhir surat Al Kahf"
            },
            16: { 
                surah: "Al-Kahf:83 - akhir surat Taha", 
                pages: "302-321",
                description: "Baca dari ayat 83 al Kahfi. Lihat awal-awal surat Thoha agar makin semangat ngaji :)"
            },
            17: { 
                surah: "Al-Anbiya & Al-Hajj", 
                pages: "322-341",
                description: "Semoga kita dimudahkan untuk haji dan umroh"
            },
            18: { 
                surah: "Awal Al-Mu'minun - Al-Furqan:20", 
                pages: "342-361",
                description: "Renungkan ayat 30 surat Al Furqon :("
            },
            19: { 
                surah: "Al-Furqan:21 - An-Naml:58", 
                pages: "362-382",
                description: "Tambah baca sampai ayat 58 surat An-Naml"
            },
            20: { 
                surah: "An-Naml:59 - Al-Ankabut 29:45", 
                pages: "382-401",
                description: "Mulai dari ayat 59"
            },
            21: { 
                surah: "Al-Ankabut:46 - Al-Ahzab:34", 
                pages: "402-421",
                description: "Tambah baca sampai ayat 34"
            },
            22: { 
                surah: "Al-Ahzab:34 - akhir surat Fathir", 
                pages: "422-440",
                description: "Renungkan surat Fathir ayat 32"
            },
            23: { 
                surah: "Awal surat Yasin - Az-Zumar 39:31", 
                pages: "440-462",
                description: ""
            },
            24: { 
                surah: "Az-Zumar:32 - Akhir Fussilat", 
                pages: "461-482",
                description: "Selesaikan surat Fushshilat, nanggung :)"
            },
            25: { 
                surah: "Awal Asy Syura - Al-Jatsiyah", 
                pages: "483-501",
                description: ""
            },
            26: { 
                surah: "Al-Ahqaf - Qaf", 
                pages: "502-520",
                description: ""
            },
            27: { 
                surah: "Adz Dzariyat - Al Hadid", 
                pages: "520-541",
                description: ""
            },
            28: { 
                surah: "Al-Mujadilah - At-Tahrim", 
                pages: "542-561",
                description: ""
            },
            29: { 
                surah: "Al-Mulk - Al-Mursalat", 
                pages: "562-581",
                description: ""
            },
            30: { 
                surah: "An-Naba - An-Nas", 
                pages: "582-604",
                description: "Langsung lanjut baca Al Fatihah + 5 ayat Al Baqarah, lalu doa khotmil :)"
            }
        };
        
        let participants = [];
        let monthlyRecords = {};
        let currentDate = new Date();
        let db = null;
        let isFirebaseConnected = false;
        let firebaseApp = null;
        let unsubscribeListeners = [];
        let lastResetCheck = null;
        let midnightResetTimeout = null;
        let clockUpdateInterval = null;
        let baseStartDate = (() => {
            const today = new Date();
            // Set ke hari ini agar dimulai dari juz 1
            const startDate = new Date(today.toLocaleString("en-US", {timeZone: "Asia/Jakarta"}));
            startDate.setHours(0, 0, 0, 0);
            return startDate;
        })(); // Tanggal mulai program - RESET KE HARI INI
        let isResetting = false; // Flag untuk mencegah multiple reset

        // PERBAIKAN TIMEZONE: Fungsi yang lebih akurat untuk timezone Jakarta
        function getJakartaTime() {
            // Menggunakan Intl.DateTimeFormat untuk timezone Jakarta yang lebih akurat
            const jakartaFormatter = new Intl.DateTimeFormat('sv-SE', {
                timeZone: 'Asia/Jakarta',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            const jakartaString = jakartaFormatter.format(new Date());
            return new Date(jakartaString);
        }

        function getJakartaDate() {
            return getJakartaTime();
        }

        function getJakartaDateKey() {
            const jakartaTime = getJakartaTime();
            return jakartaTime.toISOString().split('T')[0];
        }

        function getJakartaTimeString() {
            const jakartaTime = getJakartaTime();
            return jakartaTime.toLocaleString('id-ID', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // Update timezone display
        function updateTimezoneDisplay() {
            const timezoneElement = document.getElementById('timezone-text');
            if (timezoneElement) {
                const jakartaTimeStr = getJakartaTimeString();
                timezoneElement.textContent = `🕐 Waktu: ${jakartaTimeStr} WIB`;
            }
        }

        // Wait for Firebase modules to load
        window.initAppAfterFirebase = function() {
            // Firebase config untuk project ibkangaji
            const firebaseConfig = {
                apiKey: "AIzaSyB2GeZEZ2m2Qwq4nEzmeLlIrhN61DQusvg",
                authDomain: "ibkangaji.firebaseapp.com",
                projectId: "ibkangaji",
                storageBucket: "ibkangaji.firebasestorage.app",
                messagingSenderId: "401662109480",
                appId: "1:401662109480:web:768935620ffc698cd8521d"
            };
            
            // Auto-connect to Firebase
            connectToFirebase(firebaseConfig);
            hideFirebaseConfig();
            
            initApp();
        };

        // Firebase configuration functions
        function showFirebaseConfig() {
            document.getElementById('firebase-config-modal').style.display = 'flex';
        }

        function hideFirebaseConfig() {
            // Modal sudah dihapus, tidak perlu fungsi ini lagi
        }

        function initializeFirebase() {
            // Fungsi ini tidak diperlukan lagi karena config sudah hardcoded
        }

        function skipFirebase() {
            // Fungsi ini tidak diperlukan lagi karena config sudah hardcoded
        }

        function connectToFirebase(config) {
            try {
                // Initialize Firebase
                firebaseApp = window.firebaseModules.initializeApp(config);
                db = window.firebaseModules.getFirestore(firebaseApp);
                isFirebaseConnected = true;
                
                updateFirebaseStatus('connected', '🟢 CENTANG SESUAI NAMA | Project: ibkangaji');
                
                // Test connection dengan mencoba baca data
                testFirebaseConnection();
                
                // Setup real-time listeners
                setupFirebaseListeners();
                
                // Load data from Firebase
                loadFromFirebase();
                
                console.log('✅ Firebase connected successfully to project: ibkangaji');
                
            } catch (error) {
                console.error('❌ Firebase connection failed:', error);
                updateFirebaseStatus('error', '🔴 Firebase Error: ' + error.message);
                isFirebaseConnected = false;
                
                // Fallback to localStorage
                loadFromLocalStorage();
            }
        }

        function updateFirebaseStatus(status, message) {
            const statusElement = document.getElementById('firebase-status');
            const statusTextElement = document.getElementById('firebase-status-text');
            const actionsElement = document.getElementById('firebase-actions');
            
            statusTextElement.textContent = message;
            
            // Update styling based on status
            switch(status) {
                case 'connected':
                    statusElement.style.background = 'linear-gradient(135deg, #10B981, #34D399)';
                    actionsElement.style.display = 'none';
                    break;
                case 'offline':
                    statusElement.style.background = 'linear-gradient(135deg, #F59E0B, #FBBF24)';
                    actionsElement.style.display = 'block';
                    break;
                case 'error':
                    statusElement.style.background = 'linear-gradient(135deg, #EF4444, #F87171)';
                    actionsElement.style.display = 'block';
                    break;
            }
        }

        function testFirebaseConnection() {
            if (isFirebaseConnected && db) {
                // Test dengan mencoba baca dari collection participants
                window.firebaseModules.getDocs(
                    window.firebaseModules.collection(db, 'participants')
                ).then((snapshot) => {
                    console.log('🔍 Test read successful. Documents found:', snapshot.size);
                    alert(`✅ Firebase terhubung dengan baik!\n\nProject: ibkangaji\nStatus: Real-time sync aktif\nDocuments: ${snapshot.size}`);
                }).catch((error) => {
                    console.error('❌ Test read failed:', error);
                    alert(`❌ Firebase connection issue:\n\n${error.message}\n\nCek security rules di Firebase Console!`);
                    updateFirebaseStatus('error', '🔴 Permission denied - Cek security rules');
                });
            } else {
                alert('❌ Firebase tidak terhubung.\n\nMenggunakan mode offline.\nData tersimpan di browser lokal saja.');
            }
        }

        // Firebase data functions
        function setupFirebaseListeners() {
            if (!isFirebaseConnected || !db) return;

            try {
                // Listen to participants collection
                const participantsQuery = window.firebaseModules.query(
                    window.firebaseModules.collection(db, 'participants'),
                    window.firebaseModules.orderBy('id')
                );
                
                const unsubscribeParticipants = window.firebaseModules.onSnapshot(participantsQuery, (snapshot) => {
                    // PERBAIKAN: Hindari reset saat listener update
                    if (isResetting) {
                        console.log('🚫 Skipping Firebase listener update during reset');
                        return;
                    }

                    const firebaseParticipants = [];
                    snapshot.forEach((doc) => {
                        firebaseParticipants.push(doc.data());
                    });
                    
                    // Only update if we have data from Firebase, and don't replace initialized data unnecessarily
                    if (firebaseParticipants.length === 30) {
                        participants = firebaseParticipants;
                        // Pastikan juz update setelah load
                        updateAllParticipantsJuz();
                        renderDailyTab();
                        console.log('📡 Real-time update: participants loaded from Firebase');
                    } else if (firebaseParticipants.length > 0) {
                        // Partial data - merge with existing participants
                        firebaseParticipants.forEach(fbParticipant => {
                            const existingIndex = participants.findIndex(p => p.id === fbParticipant.id);
                            if (existingIndex !== -1) {
                                participants[existingIndex] = fbParticipant;
                            }
                        });
                        updateAllParticipantsJuz();
                        renderDailyTab();
                        console.log(`📡 Partial update: ${firebaseParticipants.length} participants updated from Firebase`);
                    }
                }, (error) => {
                    console.error('❌ Error listening to participants:', error);
                });

                // Listen to monthly records
                const monthlyQuery = window.firebaseModules.collection(db, 'monthlyRecords');
                const unsubscribeMonthly = window.firebaseModules.onSnapshot(monthlyQuery, (snapshot) => {
                    const firebaseRecords = {};
                    snapshot.forEach((doc) => {
                        firebaseRecords[doc.id] = doc.data();
                    });
                    
                    monthlyRecords = { ...monthlyRecords, ...firebaseRecords };
                    console.log('📡 Real-time update: monthly records loaded from Firebase');
                }, (error) => {
                    console.error('❌ Error listening to monthly records:', error);
                });

                unsubscribeListeners.push(unsubscribeParticipants, unsubscribeMonthly);
                
            } catch (error) {
                console.error('❌ Error setting up Firebase listeners:', error);
            }
        }

        async function saveParticipantToFirebase(participant) {
            if (!isFirebaseConnected || !db) {
                console.log('📱 Firebase not connected, saving locally only');
                return;
            }

            try {
                await window.firebaseModules.setDoc(
                    window.firebaseModules.doc(db, 'participants', participant.id.toString()),
                    participant
                );
                console.log(`✅ Participant ${participant.id} (${participant.name}) saved to Firebase`);
            } catch (error) {
                console.error('❌ Error saving participant to Firebase:', error);
                updateFirebaseStatus('error', '🔴 Save failed - Cek security rules');
            }
        }

        async function saveMonthlyRecordToFirebase(monthKey, record) {
            if (!isFirebaseConnected || !db) return;

            try {
                await window.firebaseModules.setDoc(
                    window.firebaseModules.doc(db, 'monthlyRecords', monthKey),
                    record
                );
                console.log(`✅ Monthly record ${monthKey} saved to Firebase`);
            } catch (error) {
                console.error('❌ Error saving monthly record to Firebase:', error);
            }
        }

        async function loadFromFirebase() {
            if (!isFirebaseConnected || !db) return;

            try {
                // Load participants
                const participantsSnapshot = await window.firebaseModules.getDocs(
                    window.firebaseModules.collection(db, 'participants')
                );
                
                if (!participantsSnapshot.empty) {
                    const firebaseParticipants = [];
                    participantsSnapshot.forEach((doc) => {
                        firebaseParticipants.push(doc.data());
                    });
                    
                    // Sort by ID
                    firebaseParticipants.sort((a, b) => a.id - b.id);
                    
                    if (firebaseParticipants.length === 30) {
                        participants = firebaseParticipants;
                        // PERBAIKAN: Paksa update nama dengan nama yang benar
                        participants.forEach((participant, index) => {
                            if (participantNames[index]) {
                                participant.name = participantNames[index];
                            }
                        });
                        console.log('📥 All 30 participants loaded from Firebase and names updated');
                    } else {
                        // If partial data, merge with initialized participants
                        console.log(`📥 ${firebaseParticipants.length} participants found in Firebase, initializing rest`);
                        firebaseParticipants.forEach(fbParticipant => {
                            const existingIndex = participants.findIndex(p => p.id === fbParticipant.id);
                            if (existingIndex !== -1) {
                                participants[existingIndex] = fbParticipant;
                                // PERBAIKAN: Paksa update nama
                                if (participantNames[existingIndex]) {
                                    participants[existingIndex].name = participantNames[existingIndex];
                                }
                            }
                        });
                        
                        // Save missing participants to Firebase
                        participants.forEach(participant => {
                            const exists = firebaseParticipants.find(fp => fp.id === participant.id);
                            if (!exists) {
                                saveParticipantToFirebase(participant);
                            }
                        });
                    }
                } else {
                    // No participants in Firebase, save initialized participants
                    console.log('📥 No participants in Firebase, saving initialized data');
                    participants.forEach(participant => {
                        saveParticipantToFirebase(participant);
                    });
                }

                // Update juz setelah load data
                updateAllParticipantsJuz();

                // Load monthly records
                const monthlySnapshot = await window.firebaseModules.getDocs(
                    window.firebaseModules.collection(db, 'monthlyRecords')
                );
                
                const firebaseRecords = {};
                monthlySnapshot.forEach((doc) => {
                    firebaseRecords[doc.id] = doc.data();
                });
                
                if (Object.keys(firebaseRecords).length > 0) {
                    monthlyRecords = { ...monthlyRecords, ...firebaseRecords };
                    console.log('📥 Monthly records loaded from Firebase');
                }

                // PERBAIKAN: Paksa save nama yang sudah diperbaiki ke Firebase
                participants.forEach(participant => {
                    saveParticipantToFirebase(participant);
                });

                renderDailyTab();
                
            } catch (error) {
                console.error('❌ Error loading from Firebase:', error);
            }
        }

        // Initialize app
        function initApp() {
            // PERBAIKAN: Gunakan tanggal Jakarta
            currentDate = getJakartaDate();
            
            initializeParticipants();
            updateCurrentDate();
            updateTimezoneDisplay();
            setupDailyReset();
            setupClockUpdate();
            populateMonthSelector();
            renderDailyTab();
            
            // Load from localStorage if no Firebase data
            if (!isFirebaseConnected) {
                loadFromLocalStorage();
            }
            
            console.log('✅ App initialized');
            console.log(`📅 Current date (WIB): ${getJakartaTimeString()}`);
            console.log(`📋 Participants initialized: ${participants.length}`);
        }

        // Setup clock update
        function setupClockUpdate() {
            // Update clock every second
            clockUpdateInterval = setInterval(() => {
                updateTimezoneDisplay();
            }, 1000);
        }

        // PERBAIKAN: Initialize participants dengan nama yang benar
        function initializeParticipants() {
            console.log('🔧 Initializing participants...');
            console.log('📝 Available names:', participantNames);
            
            participants = Array.from({ length: 30 }, (_, i) => {
                const participantName = participantNames[i] || `Peserta ${i + 1}`;
                console.log(`Creating participant ${i + 1}: ${participantName}`);
                
                return {
                    id: i + 1,
                    name: participantName,
                    dailyProgress: {},
                    currentJuz: 1, // Set default dulu
                    lastUpdated: getJakartaDateKey()
                };
            });
            
            // Update juz berdasarkan tanggal saat ini
            updateAllParticipantsJuz();
            
            // Verify initialization
            console.log('✅ Participants initialized:');
            participants.forEach((p, i) => {
                console.log(`${i + 1}. ID: ${p.id}, Name: ${p.name}, Juz: ${p.currentJuz}`);
            });
        }

        // PERBAIKAN: Sistem rotasi - juz tetap 1-30, peserta yang berputar
        function getRotatedParticipantOrder(currentDate) {
            // Hitung hari sejak tanggal mulai program menggunakan Jakarta time
            const jakartaCurrentDate = new Date(currentDate.toLocaleString("en-US", {timeZone: "Asia/Jakarta"}));
            const jakartaStartDate = new Date(baseStartDate.toLocaleString("en-US", {timeZone: "Asia/Jakarta"}));
            
            const diffTime = jakartaCurrentDate - jakartaStartDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Buat urutan peserta yang berputar
            // Hari 0: [Syafiq, Siti, Muhammad, ..., Umming] → Juz [1,2,3,...,30]
            // Hari 1: [Umming, Syafiq, Siti, ..., Anas] → Juz [1,2,3,...,30]
            // Yang kemarin juz 30 naik ke juz 1
            
            const rotatedOrder = [];
            for (let i = 0; i < 30; i++) {
                // Rumus rotasi: mulai dari participant yang hari ini dapat juz 1
                const participantIndex = (30 - diffDays + i) % 30;
                rotatedOrder.push(participants[participantIndex]);
            }
            
            console.log(`📖 Day ${diffDays}: Rotated order - Juz 1: ${rotatedOrder[0]?.name}, Juz 30: ${rotatedOrder[29]?.name}`);
            return rotatedOrder;
        }

        // Update juz assignments (juz tetap 1-30, peserta yang berputar)
        function updateAllParticipantsJuz() {
            // Reset semua juz dulu
            participants.forEach((participant, index) => {
                participant.currentJuz = index + 1; // Default juz sesuai urutan
            });
            console.log('🔄 Updated juz assignments - using rotation display');
        }

        // Update current date display
        function updateCurrentDate() {
            const dateStr = currentDate.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('current-date').textContent = dateStr;
        }

        // PERBAIKAN: Setup daily reset dengan timezone Jakarta yang lebih presisi
        function setupDailyReset() {
            lastResetCheck = getJakartaDateKey();
            scheduleNextMidnightReset();
            
            // Backup check setiap 30 detik dengan timezone Jakarta
            setInterval(() => {
                const today = getJakartaDateKey();
                
                if (lastResetCheck && lastResetCheck !== today && !isResetting) {
                    console.log('🔄 Date changed detected via backup check, performing reset');
                    performDailyReset();
                }
                
                lastResetCheck = today;
            }, 30000); // Check setiap 30 detik
        }

        // PERBAIKAN: Schedule reset dengan timezone Jakarta yang lebih akurat
        function scheduleNextMidnightReset() {
            if (midnightResetTimeout) {
                clearTimeout(midnightResetTimeout);
            }
            
            // Gunakan timezone Jakarta dengan perhitungan yang lebih presisi
            const now = getJakartaTime();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const timeUntilMidnight = tomorrow.getTime() - now.getTime();
            
            console.log(`⏰ Current time (WIB): ${getJakartaTimeString()}`);
            console.log(`⏰ Next reset scheduled for (WIB): ${tomorrow.toLocaleString('id-ID')}`);
            console.log(`⏰ Time until reset: ${Math.round(timeUntilMidnight / 1000 / 60)} minutes`);
            
            midnightResetTimeout = setTimeout(() => {
                console.log('🌙 MIDNIGHT RESET TRIGGERED at exactly 00:00 WIB');
                performDailyReset();
                scheduleNextMidnightReset();
            }, timeUntilMidnight);
        }

        function performDailyReset() {
            if (isResetting) {
                console.log('⚠️ Reset already in progress, skipping');
                return;
            }
            
            isResetting = true;
            console.log('🔄 Performing daily reset...');
            
            // PERBAIKAN: Gunakan tanggal Jakarta
            const now = getJakartaDate();
            console.log(`🕐 Reset performed at (WIB): ${getJakartaTimeString()}`);
            
            // Update current date
            currentDate = now;
            lastResetCheck = getJakartaDateKey();
            
            // PERBAIKAN: Update juz rotation untuk hari baru
            updateAllParticipantsJuz();
            
            // Update date display
            updateCurrentDate();
            updateTimezoneDisplay();
            
            // Re-render participants dengan juz assignments baru
            renderDailyTab();
            
            // Save updated participants
            participants.forEach(participant => {
                saveParticipantToFirebase(participant);
            });
            saveToLocalStorage();
            
            updateFirebaseStatus('connected', 
                `🌅 Reset berhasil pukul ${now.toLocaleTimeString('id-ID')} WIB | Project: ibkangaji`);
            
            console.log('✅ Daily reset completed successfully');
            
            // Reset flag setelah 5 detik
            setTimeout(() => {
                isResetting = false;
            }, 5000);
        }

        function getTodayKey() {
            return getJakartaDateKey();
        }

        // Toggle participant check
        function toggleParticipantCheck(participantId) {
            const today = getJakartaDateKey();
            const participant = participants.find(p => p.id === participantId);
            
            if (participant) {
                if (participant.dailyProgress[today]) {
                    delete participant.dailyProgress[today];
                } else {
                    participant.dailyProgress[today] = true;
                }
                
                renderDailyTab();
                updateMonthlyRecords();
                
                // Save to Firebase
                saveParticipantToFirebase(participant);
                
                // Save to localStorage as backup
                saveToLocalStorage();
            }
        }

        // PERBAIKAN: Render daily tab dengan rotasi peserta
        function renderDailyTab() {
            const today = getJakartaDateKey();
            
            // Pastikan ada 30 participants
            if (participants.length !== 30) {
                console.warn(`⚠️ Expected 30 participants, found ${participants.length}. Re-initializing...`);
                initializeParticipants();
            }
            
            const completedToday = participants.filter(p => p.dailyProgress && p.dailyProgress[today]).length;
            
            // Update stats
            document.getElementById('completed-today').textContent = completedToday;
            document.getElementById('khatam-status').textContent = 
                completedToday === 30 ? 'Khatam Hari Ini! 🎉' : `${30 - completedToday} Lagi untuk Khatam`;
            
            // PERBAIKAN: Gunakan urutan peserta yang berputar
            const rotatedParticipants = getRotatedParticipantOrder(currentDate);
            
            // Render participants
            const grid = document.getElementById('participants-grid');
            grid.innerHTML = '';
            
            rotatedParticipants.forEach((participant, index) => {
                const isCompleted = participant.dailyProgress && participant.dailyProgress[today];
                const juzNumber = index + 1; // Juz sesuai posisi (1-30 dari atas ke bawah)
                const juzDetail = juzDetails[juzNumber] || { 
                    surah: "Detail tidak tersedia", 
                    pages: "?",
                    description: "Silakan cek Al-Qur'an"
                };
                
                // Debug log untuk rotasi
                if (index < 5) { // Log first 5 for debugging
                    console.log(`🔍 Position ${index + 1}: ${participant.name} → Juz ${juzNumber}`);
                }
                
                const card = document.createElement('div');
                card.className = `participant-card ${isCompleted ? 'completed' : ''}`;
                card.onclick = () => toggleParticipantCheck(participant.id);
                
                // Pastikan nama tidak undefined
                const displayName = participant.name || `Peserta ${participant.id}`;
                
                card.innerHTML = `
                    <div class="participant-content">
                        <div class="participant-info">
                            <h3>${displayName}</h3>
                            <p style="font-weight: 600; color: #FF7D29; margin-bottom: 6px;">
                                📖 Juz ${juzNumber} (Hal. ${juzDetail.pages})
                            </p>
                            <div class="juz-info">
                                <p>${juzDetail.surah}</p>
                                ${juzDetail.description ? `<p class="description">${juzDetail.description}</p>` : ''}
                            </div>
                            ${isCompleted ? '<small style="color: #10B981; font-weight: 600;">✅ Sudah Selesai</small>' : '<small style="color: #6B7280;">⏳ Belum selesai</small>'}
                        </div>
                        <div class="participant-actions">
                            <span class="icon ${isCompleted ? 'icon-completed' : 'icon-pending'}">📖</span>
                            <span class="icon ${isCompleted ? 'icon-completed' : 'icon-pending'}">✅</span>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            console.log(`🎨 Rendered ${rotatedParticipants.length} participants with rotation`);
            console.log(`📋 Today's assignment - Juz 1: ${rotatedParticipants[0]?.name}, Juz 30: ${rotatedParticipants[29]?.name}`);
        }

        // Switch tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'monthly') {
                setTimeout(() => {
                    populateMonthSelector();
                    renderMonthlyTab();
                }, 100);
            }
        }

        // Populate month selector
        function populateMonthSelector() {
            const selector = document.getElementById('month-selector');
            if (!selector) {
                console.warn('Month selector not found, will try again later');
                return;
            }
            
            const months = getAvailableMonths();
            const currentMonthKey = getJakartaDateKey().substring(0, 7);
            
            const currentSelection = selector.value;
            
            selector.innerHTML = '';
            
            if (months.length === 0) {
                const fallbackMonth = {
                    key: currentMonthKey,
                    name: currentDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' })
                };
                months.push(fallbackMonth);
            }
            
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.key;
                option.textContent = month.name;
                
                if ((currentSelection && month.key === currentSelection) || 
                    (!currentSelection && month.key === currentMonthKey)) {
                    option.selected = true;
                }
                
                selector.appendChild(option);
            });
            
            console.log(`📅 Generated ${months.length} months for selector:`, 
                       months.map(m => m.name));
        }

        // Get available months
        function getAvailableMonths() {
            const months = [];
            const startDate = new Date('2025-06-01');
            const currentMonth = getJakartaDate();
            
            console.log(`📅 Generating months from ${startDate.toDateString()} to ${currentMonth.toDateString()}`);
            
            while (startDate <= currentMonth) {
                const monthKey = startDate.toISOString().substring(0, 7);
                const monthName = startDate.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long'
                });
                months.push({ key: monthKey, name: monthName });
                startDate.setMonth(startDate.getMonth() + 1);
            }
            
            console.log(`📅 Generated ${months.length} months:`, months.map(m => m.name));
            return months.reverse();
        }

        // Update monthly records
        function updateMonthlyRecords() {
            const today = getJakartaDateKey();
            const monthKey = today.substring(0, 7);
            
            if (!monthlyRecords[monthKey]) {
                monthlyRecords[monthKey] = {
                    khatamCount: 0,
                    participantProgress: {},
                    dailyCompletions: {}
                };
            }
            
            const monthRecord = monthlyRecords[monthKey];
            
            // Update participant progress
            participants.forEach(participant => {
                const monthlyChecks = Object.keys(participant.dailyProgress)
                    .filter(date => date.startsWith(monthKey))
                    .length;
                monthRecord.participantProgress[participant.id] = monthlyChecks;
            });
            
            // Check for khatam
            const todayCompletions = participants.filter(p => p.dailyProgress[today]).length;
            if (todayCompletions === 30) {
                monthRecord.dailyCompletions[today] = true;
            } else {
                delete monthRecord.dailyCompletions[today];
            }
            
            monthRecord.khatamCount = Object.keys(monthRecord.dailyCompletions).length;
            
            // Save to Firebase
            saveMonthlyRecordToFirebase(monthKey, monthRecord);
        }

        // Render monthly tab
        function renderMonthlyTab() {
            const selectedMonth = document.getElementById('month-selector').value;
            const monthRecord = monthlyRecords[selectedMonth] || {
                khatamCount: 0,
                participantProgress: {},
                dailyCompletions: {}
            };
            
            // Update monthly stats
            document.getElementById('monthly-khatam').textContent = monthRecord.khatamCount + 'x';
            
            const totalParticipation = Object.values(monthRecord.participantProgress)
                .reduce((sum, count) => sum + count, 0);
            document.getElementById('monthly-participation').textContent = totalParticipation;
            
            // Render progress grid
            const progressGrid = document.getElementById('progress-grid');
            progressGrid.innerHTML = '';
            
            participants.forEach(participant => {
                const monthlyCount = monthRecord.participantProgress[participant.id] || 0;
                const percentage = Math.round((monthlyCount / 30) * 100);
                
                const progressItem = document.createElement('div');
                progressItem.className = 'progress-item';
                progressItem.innerHTML = `
                    <div class="progress-header">
                        <span class="progress-name">${participant.name}</span>
                        <span class="progress-count">${monthlyCount}/30</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div class="progress-percentage">${percentage}%</div>
                `;
                
                progressGrid.appendChild(progressItem);
            });
        }

        // Update monthly view
        function updateMonthlyView() {
            renderMonthlyTab();
        }

        // Local storage functions (as backup)
        function saveToLocalStorage() {
            localStorage.setItem('participants', JSON.stringify(participants));
            localStorage.setItem('monthlyRecords', JSON.stringify(monthlyRecords));
            localStorage.setItem('currentDate', currentDate.toISOString());
        }

        function loadFromLocalStorage() {
            const savedParticipants = localStorage.getItem('participants');
            const savedMonthlyRecords = localStorage.getItem('monthlyRecords');
            const savedDate = localStorage.getItem('currentDate');
            
            if (savedParticipants) {
                const localParticipants = JSON.parse(savedParticipants);
                if (participants.length === 0) {
                    participants = localParticipants;
                    // PERBAIKAN: Paksa update nama dengan nama yang benar
                    participants.forEach((participant, index) => {
                        if (participantNames[index]) {
                            participant.name = participantNames[index];
                        }
                    });
                    // Update juz setelah load dari localStorage
                    updateAllParticipantsJuz();
                    console.log('📥 Participants loaded from localStorage and names updated');
                }
            }
            
            if (savedMonthlyRecords) {
                const localRecords = JSON.parse(savedMonthlyRecords);
                if (Object.keys(monthlyRecords).length === 0) {
                    monthlyRecords = localRecords;
                }
            }
            
            if (savedDate) {
                const savedDateObj = new Date(savedDate);
                const today = getJakartaDate();
                if (savedDateObj.toDateString() !== today.toDateString()) {
                    currentDate = today;
                    updateAllParticipantsJuz();
                }
            }
            
            renderDailyTab();
        }

        // Cleanup function
        window.addEventListener('beforeunload', () => {
            if (midnightResetTimeout) {
                clearTimeout(midnightResetTimeout);
            }
            
            if (clockUpdateInterval) {
                clearInterval(clockUpdateInterval);
            }
            
            unsubscribeListeners.forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
        });

        // Debug functions (available in console)
        window.debugFunctions = {
            testReset: () => {
                console.log('🧪 Manual reset test triggered');
                performDailyReset();
            },
            checkSchedule: () => {
                const now = getJakartaTime();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                const timeUntilMidnight = tomorrow.getTime() - now.getTime();
                
                console.log('📊 Reset Schedule Info (WIB):');
                console.log(`Current time: ${getJakartaTimeString()}`);
                console.log(`Next reset: ${tomorrow.toLocaleString('id-ID')}`);
                console.log(`Time until reset: ${Math.round(timeUntilMidnight / 1000 / 60)} minutes`);
                console.log(`Last reset check: ${lastResetCheck}`);
                console.log(`Current date key: ${getJakartaDateKey()}`);
            },
            forceNewDay: () => {
                console.log('🧪 Force new day simulation');
                const tomorrow = getJakartaDate();
                tomorrow.setDate(tomorrow.getDate() + 1);
                currentDate = tomorrow;
                performDailyReset();
            },
            checkJuzRotation: () => {
                console.log('📖 Current Rotation System:');
                const rotatedOrder = getRotatedParticipantOrder(currentDate);
                
                console.log('📋 Today\'s assignments:');
                rotatedOrder.forEach((participant, index) => {
                    const juzNumber = index + 1;
                    console.log(`Juz ${juzNumber}: ${participant.name} (ID: ${participant.id})`);
                });
                
                const jakartaCurrentDate = new Date(currentDate.toLocaleString("en-US", {timeZone: "Asia/Jakarta"}));
                const jakartaStartDate = new Date(baseStartDate.toLocaleString("en-US", {timeZone: "Asia/Jakarta"}));
                const diffTime = jakartaCurrentDate - jakartaStartDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                console.log(`📅 Days since start: ${diffDays}`);
                console.log(`📖 Juz 1 (Top): ${rotatedOrder[0]?.name}`);
                console.log(`📖 Juz 30 (Bottom): ${rotatedOrder[29]?.name}`);
                
                console.log('\n🔮 Tomorrow\'s preview:');
                const tomorrow = new Date(currentDate);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowOrder = getRotatedParticipantOrder(tomorrow);
                console.log(`Juz 1 (Top): ${tomorrowOrder[0]?.name} (today's Juz 30)`);
                console.log(`Juz 2: ${tomorrowOrder[1]?.name} (today's Juz 1)`);
            },
            checkNamesDebug: () => {
                console.log('🔍 Debugging nama peserta:');
                console.log('📝 participantNames array:', participantNames);
                console.log('📝 participantNames length:', participantNames.length);
                console.log('👥 Current participants:');
                participants.forEach((p, i) => {
                    console.log(`  ${i + 1}. ID: ${p.id} | Name: "${p.name}" | From array: "${participantNames[i]}" | Juz: ${p.currentJuz}`);
                });
                
                // Check if names are properly assigned
                const missingNames = participants.filter(p => !p.name || p.name.startsWith('Peserta'));
                if (missingNames.length > 0) {
                    console.warn('⚠️ Found participants with missing names:', missingNames);
                } else {
                    console.log('✅ All participants have proper names');
                }
            },
            forceFixNames: () => {
                console.log('🔧 Force fixing participant names...');
                console.log('📝 Available names:', participantNames);
                
                // Paksa update semua nama
                participants.forEach((participant, index) => {
                    const oldName = participant.name;
                    participant.name = participantNames[index] || `Peserta ${participant.id}`;
                    console.log(`${participant.id}. "${oldName}" → "${participant.name}"`);
                });
                
                // Save ke Firebase dan localStorage
                participants.forEach(participant => {
                    saveParticipantToFirebase(participant);
                });
                saveToLocalStorage();
                
                // Re-render
                renderDailyTab();
                
                console.log('✅ Names fixed and saved to Firebase + localStorage');
            },
            testTimezone: () => {
                const utc = new Date();
                const jakarta = getJakartaTime();
                console.log('🌍 Timezone Test:');
                console.log(`UTC: ${utc.toISOString()}`);
                console.log(`Jakarta: ${getJakartaTimeString()} (${jakarta.toISOString()})`);
                console.log(`Date key Jakarta: ${getJakartaDateKey()}`);
                
                // Test midnight calculation
                const tomorrow = new Date(jakarta);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                const timeUntilMidnight = tomorrow.getTime() - jakarta.getTime();
                
                console.log(`⏰ Time until next midnight (Jakarta): ${Math.round(timeUntilMidnight / 1000 / 60)} minutes`);
                console.log(`⏰ Next midnight will be: ${tomorrow.toLocaleString('id-ID')}`);
            },
            resetToToday: () => {
                console.log('🔄 RESET: Setting start date to today');
                const today = getJakartaDate();
                baseStartDate = new Date(today);
                baseStartDate.setHours(0, 0, 0, 0);
                
                console.log(`📅 New start date: ${baseStartDate.toLocaleDateString('id-ID')}`);
                
                // Clear all progress
                participants.forEach(participant => {
                    participant.dailyProgress = {};
                });
                
                // Update system with new base date
                updateAllParticipantsJuz();
                
                // Save to Firebase and localStorage
                participants.forEach(participant => {
                    saveParticipantToFirebase(participant);
                });
                saveToLocalStorage();
                
                // Re-render
                renderDailyTab();
                
                console.log('✅ RESET COMPLETED - Program dimulai hari ini');
                console.log('📖 Sistem rotasi: Juz 1-30 tetap urut, peserta yang berputar');
                
                // Show current assignment
                const rotatedOrder = getRotatedParticipantOrder(currentDate);
                console.log(`📋 Hari ini - Juz 1: ${rotatedOrder[0]?.name}, Juz 30: ${rotatedOrder[29]?.name}`);
            },
            clearAllProgress: () => {
                if (confirm('⚠️ BAHAYA! Ini akan menghapus SEMUA progress bacaan!\n\nLanjutkan?')) {
                    console.log('🗑️ Clearing all daily progress...');
                    
                    participants.forEach(participant => {
                        participant.dailyProgress = {};
                    });
                    
                    monthlyRecords = {};
                    
                    // Save to Firebase and localStorage
                    participants.forEach(participant => {
                        saveParticipantToFirebase(participant);
                    });
                    saveToLocalStorage();
                    
                    // Re-render
                    renderDailyTab();
                    
                    console.log('✅ All progress cleared');
                    alert('✅ Semua progress telah dihapus!');
                }
            },
            previewTomorrow: () => {
                console.log('🔮 PREVIEW BESOK:');
                const tomorrow = new Date(currentDate);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const tomorrowOrder = getRotatedParticipantOrder(tomorrow);
                
                console.log('📋 Urutan besok:');
                console.log(`Juz 1 (Paling Atas): ${tomorrowOrder[0]?.name} ← Hari ini Juz 30`);
                console.log(`Juz 2: ${tomorrowOrder[1]?.name} ← Hari ini Juz 1`);
                console.log(`Juz 3: ${tomorrowOrder[2]?.name} ← Hari ini Juz 2`);
                console.log('...');
                console.log(`Juz 30 (Paling Bawah): ${tomorrowOrder[29]?.name} ← Hari ini Juz 29`);
                
                console.log('\n✅ Konfirmasi sistem rotasi benar:');
                console.log('- Juz 1-30 tetap urut dari atas ke bawah');
                console.log('- Yang kemarin Juz 30 naik ke Juz 1 (paling atas)');
                console.log('- Yang lain turun satu posisi');
            }
        };

        // Make debug functions available
        console.log('🔧 Debug functions available:');
        console.log('- debugFunctions.testReset() - Test reset manually');
        console.log('- debugFunctions.checkSchedule() - Check reset schedule');
        console.log('- debugFunctions.forceNewDay() - Simulate new day');
        console.log('- debugFunctions.checkJuzRotation() - Check rotation system');
        console.log('- debugFunctions.previewTomorrow() - 🔮 Preview tomorrow rotation');
        console.log('- debugFunctions.testTimezone() - Test timezone Jakarta');
        console.log('- debugFunctions.resetToToday() - 🔥 RESET: Start program from today');
        console.log('- debugFunctions.clearAllProgress() - 🗑️ Clear all reading progress');
        console.log('');
        console.log('🔄 FIXED TIMEZONE SYSTEM:');
        console.log('🕐 Reset sekarang akan tepat pada pukul 00:00 WIB');
        console.log('📖 Juz 1-30 tetap urut dari atas ke bawah');
        console.log('👥 Peserta yang berputar - yang kemarin juz 30 naik ke juz 1');
    </script>
</body>
</html>
